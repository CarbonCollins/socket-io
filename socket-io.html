<link rel="import" href="../polymer/polymer.html">
<script src="../socket.io-client/dist/socket.io.slim.js"></script>

<!--
`socket-io`
Polymer 1.0 element for socket.io apis

@demo demo/index.html
-->

<dom-module id="socket-io">
  <template>
  </template>
  <script>
    Polymer({
      is: 'socket-io',
      properties: {
        endpoint: {
          type: String,
          value: 'http://localhost:8080'
        },
        isConnected: {
          type: Boolean,
          value: null
        },
        loaded: {
          type: Function
        },
        /**
        * Array with child objects - two properties.
        * event (name of event to trigger on) and onEvent (a callback function).
        */
        events: {
          type: Array,
          value: [{ event: "onConnect", onEvent: function(data){
            console.log("connected");
          }}]
        }
      },
      ready: function(){
        console.log("Connection In Progress");
        if(this.loaded){
          this.loaded();
        }
      },

      /**
       * The emit method sends an event with 'payload' as content and allows optional compression
       *
       * @method emit
       * @param {String} event event to send
       * @param {Object} payload the json data to send
       * @param {Boolean} compres the event
       */
      emit: function(event, data, compress)
	    {
			  try
			  {
          if(this.socket) this.socket.compress(compress).emit(event, data);
			  }catch(error)
			  {
				  console.log("Failed to send message: "+error);
			  }
      },
      /**
       * Update the message within state
       *
       * @method message
       */
      _updateMessage: function(message){
        if(typeof message !== "object"){
          this.outMessage = {message: message};
        } else{
          this.outMessage = message;
        }
      },
      /**
       * The connect method triggers connection to the socket.io server
       *
       * @method connect
       */
	    connect: function()
	    {
        console.log('Connection in progress');
		    this.disconnect();
        this.socket = io.connect(this.endpoint);
        var ths = this;
        this.isConnected = true;
        this.events.forEach(function(event){
          ths.socket.on(event.event, event.onEvent);
        });
	    },
	    /**
       * The disconnect method triggers disconnection from the socket.io server
       *
       * @method disconnect
       */
	    disconnect:function()
	    {
		    if (this.socket != undefined && !this.isConnected)
		    {
          try{
            this.socket.disconnect();
            this.isConnected = false;
          }
          catch(error){
            this.onError(error);
          }
        }
	    },
      /**
       * Register extra events 
       *
       * @method registerEvents
       * @param {array} events - an array of events to registerEvents
       * @param {string} eventArr[].event - name of the event 
       * @param {function} eventArr[].onEvent - Function to be called when event is triggered
       */
      registerEvents: function(events) {
        if (events && Array.isArray(events) && events.length > 0) {
          for (let i = 0, iLength = events.length; i < iLength; i += 1) {
            const index = (this.events.push(events[i]) - 1);
            this.socket.on(this.events[index].event, this.events[index].onEvent);
          };
        }
      },
      /**
       * Register a one shot event
       *
       * @method registerOnceEvent
       * @param {string} eventName - the name of the event
       * @param {function} onEvent - function to be called when the event is triggered
       */
      registerOnceEvent: function(eventName, onEvent) {
        this.socket.once(eventName, onEvent);
      }
    });
  </script>
</dom-module>
